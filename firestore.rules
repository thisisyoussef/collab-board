rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function boardMemberDocPath(boardId, userId) {
      return /databases/$(database)/documents/boardMembers/$(boardId + "_" + userId);
    }

    function boardDocPath(boardId) {
      return /databases/$(database)/documents/boards/$(boardId);
    }

    function normalizeVisibility(data) {
      return data.sharing is map &&
        (data.sharing.visibility == 'private' ||
          data.sharing.visibility == 'auth_link' ||
          data.sharing.visibility == 'public_link')
        ? data.sharing.visibility
        : 'auth_link';
    }

    function normalizeAuthLinkRole(data) {
      return data.sharing is map &&
        (data.sharing.authLinkRole == 'editor' || data.sharing.authLinkRole == 'viewer')
        ? data.sharing.authLinkRole
        : 'editor';
    }

    function normalizePublicLinkRole(data) {
      return data.sharing is map &&
        (data.sharing.publicLinkRole == 'editor' || data.sharing.publicLinkRole == 'viewer')
        ? data.sharing.publicLinkRole
        : 'viewer';
    }

    function boardOwnerId(data) {
      return data.ownerId is string
        ? data.ownerId
        : data.createdBy is string
          ? data.createdBy
          : null;
    }

    function explicitMemberRole(boardId) {
      let memberDoc = isSignedIn()
        ? get(boardMemberDocPath(boardId, request.auth.uid))
        : null;
      return memberDoc != null &&
        memberDoc.data != null &&
        (memberDoc.data.role == 'owner' ||
          memberDoc.data.role == 'editor' ||
          memberDoc.data.role == 'viewer')
        ? memberDoc.data.role
        : null;
    }

    function isOwner(data) {
      let ownerId = boardOwnerId(data);
      return isSignedIn() &&
        ownerId != null &&
        ownerId == request.auth.uid;
    }

    function effectiveBoardRole(boardId, data) {
      let explicitRole = explicitMemberRole(boardId);
      let visibility = normalizeVisibility(data);
      return isOwner(data)
        ? 'owner'
        : explicitRole != null
          ? explicitRole
          : visibility == 'private'
            ? 'none'
            : visibility == 'auth_link'
              ? (isSignedIn() ? normalizeAuthLinkRole(data) : 'none')
              : normalizePublicLinkRole(data);
    }

    function canReadBoard(boardId, data) {
      return effectiveBoardRole(boardId, data) != 'none';
    }

    function canEditBoard(boardId, data) {
      let role = effectiveBoardRole(boardId, data);
      return role == 'owner' || role == 'editor';
    }

    function hasValidSharingShape(data) {
      return !(data.sharing is map) ||
        (
          (data.sharing.visibility == 'private' ||
            data.sharing.visibility == 'auth_link' ||
            data.sharing.visibility == 'public_link') &&
          (data.sharing.authLinkRole == 'editor' || data.sharing.authLinkRole == 'viewer') &&
          (data.sharing.publicLinkRole == 'editor' || data.sharing.publicLinkRole == 'viewer')
        );
    }

    function linkRoleForSignedInUser(data) {
      let visibility = normalizeVisibility(data);
      return visibility == 'auth_link'
        ? normalizeAuthLinkRole(data)
        : visibility == 'public_link'
          ? normalizePublicLinkRole(data)
          : 'none';
    }

    function immutableBoardFieldsUnchanged() {
      return request.resource.data.ownerId == resource.data.ownerId &&
        request.resource.data.createdBy == resource.data.createdBy &&
        request.resource.data.createdAt == resource.data.createdAt &&
        request.resource.data.schemaVersion == resource.data.schemaVersion;
    }

    function isBoardOwner(boardId) {
      let boardDoc = get(boardDocPath(boardId));
      let ownerId = boardDoc.data != null ? boardOwnerId(boardDoc.data) : null;
      return isSignedIn() &&
        ownerId != null &&
        ownerId == request.auth.uid;
    }

    match /boards/{boardId} {
      allow read: if canReadBoard(boardId, resource.data);

      allow create: if isSignedIn() &&
        request.resource.data.ownerId is string &&
        request.resource.data.ownerId == request.auth.uid &&
        (
          request.resource.data.createdBy == null ||
          request.resource.data.createdBy == request.auth.uid
        ) &&
        hasValidSharingShape(request.resource.data);

      allow update: if canEditBoard(boardId, resource.data) &&
        hasValidSharingShape(request.resource.data) &&
        (
          isOwner(resource.data) ||
          (
            request.resource.data.sharing == resource.data.sharing &&
            immutableBoardFieldsUnchanged()
          )
        );

      allow delete: if isOwner(resource.data);
    }

    match /boardMembers/{membershipId} {
      allow read: if isSignedIn() &&
        (
          // Allow users to check their own membership doc even before it exists.
          membershipId.matches('^.+_' + request.auth.uid + '$') ||
          (
            resource.data.boardId is string &&
            resource.data.userId is string &&
            resource.data.userId == request.auth.uid
          ) ||
          (
            resource.data.boardId is string &&
            isBoardOwner(resource.data.boardId)
          )
        );

      allow create: if isSignedIn() &&
        request.resource.data.boardId is string &&
        request.resource.data.userId is string &&
        membershipId == request.resource.data.boardId + "_" + request.resource.data.userId &&
        (request.resource.data.role == 'editor' ||
          request.resource.data.role == 'viewer') &&
        (
          isBoardOwner(request.resource.data.boardId) ||
          (
            request.resource.data.userId == request.auth.uid &&
            get(boardDocPath(request.resource.data.boardId)).data is map &&
            linkRoleForSignedInUser(get(boardDocPath(request.resource.data.boardId)).data) != 'none' &&
            request.resource.data.role ==
              linkRoleForSignedInUser(get(boardDocPath(request.resource.data.boardId)).data)
          )
        );

      allow update: if isSignedIn() &&
        resource.data.boardId is string &&
        resource.data.userId is string &&
        membershipId == resource.data.boardId + "_" + resource.data.userId &&
        request.resource.data.boardId == resource.data.boardId &&
        request.resource.data.userId == resource.data.userId &&
        (request.resource.data.role == 'editor' ||
          request.resource.data.role == 'viewer') &&
        isBoardOwner(resource.data.boardId);

      allow delete: if isSignedIn() &&
        resource.data.boardId is string &&
        isBoardOwner(resource.data.boardId);
    }
  }
}
